#!/bin/bash

# AI IS ABSOLUTELY BONKERS!!!


# --- Add System76 Repository for Arch Linux ---
echo "Adding System76 repository and GPG key for Arch Linux..."
# Add the key
sudo pacman-key --recv-keys --keyserver keyserver.ubuntu.com F677011E0E20A9A7
sudo pacman-key --lsign-key F677011E0E20A9A7

# Add the repository to /etc/pacman.conf if not already present
SYSTEM76_REPO_LINE="[system76]"
SYSTEM76_SERVER_LINE="Server = http://apt.pop-os.org/archlinux/\$arch" # Use \$arch to prevent shell expansion here

if ! grep -Fxq "$SYSTEM76_REPO_LINE" /etc/pacman.conf; then
    echo "Adding System76 repository to /etc/pacman.conf..."
    printf "\n%s\n%s\n" "$SYSTEM76_REPO_LINE" "$SYSTEM76_SERVER_LINE" | sudo tee -a /etc/pacman.conf > /dev/null
else
    echo "System76 repository already found in /etc/pacman.conf."
fi

# Update sources
echo "Updating package database..."
sudo pacman -Syu

# Install System76 software
echo "Installing System76 software components..."
sudo pacman -S --noconfirm --needed system76-firmware-daemon system76-power system76-dkms

# Install NVIDIA drivers (Arch Linux way)
echo "For NVIDIA graphics, please install the appropriate drivers manually."
echo "Example: sudo pacman -S nvidia (for latest proprietary) or nvidia-dkms"
echo "Ensure you have the correct linux headers installed (e.g., linux-headers)."

# Install pesign
echo "Installing pesign..."
sudo pacman -S --noconfirm --needed pesign

# --- MOK Utility (Manual Steps Required) ---
echo ""
echo "---------------------------------------------------------------------------"
echo "IMPORTANT: Secure Boot & Kernel Signing (MOK Utility)"
echo "The following commands are for signing your kernel if you use Secure Boot."
echo "These are ADVANCED steps and require MANUAL ADAPTATION."
echo ""
echo "1. Identify the exact kernel image path you need to sign."
echo "   Example: /boot/vmlinuz-linux, /boot/vmlinuz-linux-lts, etc."
echo "2. Replace '/boot/vmlinuz-YOUR-KERNEL-VERSION' with your actual kernel path."
echo "3. The hash 'YOUR_KERNEL_HASH_HERE' will be output by the 'pesign' command."
echo "   You MUST use the hash specific to YOUR kernel."
echo ""
echo "# Example commands (DO NOT RUN AS IS - ADAPT THEM):"
echo "# sudo pesign -s -i /boot/vmlinuz-YOUR-KERNEL-VERSION -o /boot/vmlinuz-YOUR-KERNEL-VERSION.signed -c YOUR_CERT_NICKNAME"
echo "# sudo mokutil --import /path/to/your/signing_key.der  (if key not enrolled)"
echo "# sudo mokutil --import-hash YOUR_KERNEL_HASH_HERE (if using hash)"
echo "---------------------------------------------------------------------------"

echo "System76 software installation script finished."

